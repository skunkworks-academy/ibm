<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>DataStage Lineage Dashboard</title>
<style>
  :root{
    --bg:#f7fafc; --panel:#fff; --ink:#0f172a; --muted:#475569;
    --accent:#2563eb; --border:#e2e8f0; --badge:#eef2ff;
  }
  *{box-sizing:border-box}
  body{margin:0; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; color:var(--ink); background:var(--bg);}
  header{max-width:1200px; margin:28px auto 0; padding:0 20px;}
  h1{margin:0 0 6px; font-size:clamp(24px, 3vw, 34px)}
  .sub{color:var(--muted)}
  .grid{max-width:1200px; margin:16px auto; padding:0 20px; display:grid; grid-template-columns:repeat(12,1fr); gap:16px;}
  .card{grid-column: span 12; background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px 18px; box-shadow:0 6px 20px rgba(2,6,23,.06);}
  @media(min-width:900px){
    .span6{grid-column: span 6}
    .span8{grid-column: span 8}
    .span4{grid-column: span 4}
  }
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .btn{appearance:none; border:1px solid var(--border); background:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600}
  .btn.primary{background:var(--accent); color:#fff; border-color:transparent}
  .btn:disabled{opacity:.5; cursor:not-allowed}
  .badge{display:inline-block; background:var(--badge); border:1px solid var(--border); padding:4px 8px; border-radius:999px; font-size:12px; margin-right:6px}
  table{width:100%; border-collapse:collapse; font-size:14px}
  th,td{border-bottom:1px solid var(--border); padding:8px 10px; text-align:left}
  th{background:#f8fafc}
  .hint{color:var(--muted); font-size:14px}
  input[type="search"]{width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px}
  .nowrap{white-space:nowrap}
  footer{max-width:1200px; margin:10px auto 40px; padding:0 20px; color:var(--muted);}
  .imgwrap{display:flex; justify-content:center; align-items:center; min-height:200px; border:1px dashed var(--border); border-radius:12px; background:#fcfdff}
  .hidden{display:none}
</style>
</head>
<body>
<header>
  <h1>DataStage Lineage Dashboard</h1>
  <div class="sub">Browse outputs generated by the DSX/ISX lineage extractor (job_endpoints.csv, job_edges.csv, lineage.dot/png).</div>
</header>

<section class="grid">
  <div class="card span6">
    <h2>Quick Links</h2>
    <div class="row">
      <a class="btn" href="./out/job_endpoints.csv" download>Download job_endpoints.csv</a>
      <a class="btn" href="./out/job_edges.csv" download>Download job_edges.csv</a>
      <a class="btn" href="./out/lineage.dot" download>Download lineage.dot</a>
      <a class="btn" href="./out/lineage.png" download>Download lineage.png</a>
    </div>
    <p class="hint">Place this file alongside an <code>out/</code> folder containing the CSV/DOT/PNG files.</p>
  </div>

  <div class="card span6">
    <h2>Filters</h2>
    <div class="row">
      <span class="badge">Project/Job</span>
      <input id="q" type="search" placeholder="Search job, stage, table, link…">
      <button id="clear" class="btn">Clear</button>
      <button id="reload" class="btn">Reload</button>
    </div>
  </div>

  <div class="card span8">
    <h2>Source → Target Catalog (job_endpoints.csv)</h2>
    <div class="hint">One row per job source/target endpoint pair. Click headers to sort.</div>
    <div style="overflow:auto; max-height:420px">
      <table id="tbl_endpoints">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card span4">
    <h2>Graph Preview (lineage.png)</h2>
    <div class="imgwrap"><img id="gimg" src="./out/lineage.png" alt="lineage graph" class="hidden" style="max-width:100%; border-radius:8px"></div>
    <div class="hint">If the image is missing, generate it with: <code>dot -Tpng out/lineage.dot -o out/lineage.png</code></div>
  </div>

  <div class="card span12">
    <h2>Edges (job_edges.csv)</h2>
    <div class="hint">Every stage-to-stage edge with link names. Use this to trace “how” data flows.</div>
    <div style="overflow:auto; max-height:360px">
      <table id="tbl_edges">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</section>

<footer>
  <div>© Lineage Report • Works offline • Place next to the <code>out/</code> folder.</div>
</footer>

<script>
function csvToRows(text){
  const lines = text.replace(/\r/g,'').split('\\n').filter(Boolean);
  return lines.map(line=>{
    const parts = []; let cur = ''; let inq = false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c=='"'){inq = !inq; continue;}
      if(c==',' && !inq){ parts.push(cur); cur=''; continue;}
      cur += c;
    }
    parts.push(cur);
    return parts.map(s=>s.trim());
  });
}
function renderTable(el, rows){
  const thead = el.querySelector('thead');
  const tbody = el.querySelector('tbody');
  thead.innerHTML = ''; tbody.innerHTML = '';
  if(!rows.length) return;
  const hdr = document.createElement('tr');
  rows[0].forEach((h,i)=>{
    const th = document.createElement('th');
    th.textContent = h;
    th.style.cursor='pointer';
    th.addEventListener('click', ()=> sortBy(el, i));
    hdr.appendChild(th);
  });
  thead.appendChild(hdr);
  rows.slice(1).forEach(r=>{
    const tr = document.createElement('tr');
    r.forEach((c,idx)=>{
      const td = document.createElement('td');
      td.textContent = c;
      if(idx===0) td.classList.add('nowrap');
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}
function sortBy(el, col){
  const tbody = el.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const asc = el._asc = !el._asc;
  rows.sort((a,b)=>{
    const ta = a.children[col].textContent.toLowerCase();
    const tb = b.children[col].textContent.toLowerCase();
    if(ta<tb) return asc?-1:1;
    if(ta>tb) return asc?1:-1;
    return 0;
  });
  rows.forEach(r=>tbody.appendChild(r));
}
async function tryLoad(path){
  try{
    const r = await fetch(path);
    if(!r.ok) throw new Error(r.statusText);
    return await r.text();
  }catch(e){ return null; }
}
async function loadAll(){
  const q = document.getElementById('q').value.trim().toLowerCase();
  const ep = await tryLoad('./out/job_endpoints.csv');
  if(ep){
    const rows = csvToRows(ep);
    const f = q ? [rows[0]].concat(rows.slice(1).filter(r=>r.join(' ').toLowerCase().includes(q))) : rows;
    renderTable(document.getElementById('tbl_endpoints'), f);
  }else{
    renderTable(document.getElementById('tbl_endpoints'), []);
  }
  const ed = await tryLoad('./out/job_edges.csv');
  if(ed){
    const rows = csvToRows(ed);
    const f = q ? [rows[0]].concat(rows.slice(1).filter(r=>r.join(' ').toLowerCase().includes(q))) : rows;
    renderTable(document.getElementById('tbl_edges'), f);
  }else{
    renderTable(document.getElementById('tbl_edges'), []);
  }
  const img = document.getElementById('gimg');
  const res = await fetch('./out/lineage.png').catch(()=>null);
  if(res && res.ok){ img.classList.remove('hidden'); } else { img.classList.add('hidden'); }
}
document.getElementById('reload').addEventListener('click', loadAll);
document.getElementById('clear').addEventListener('click', ()=>{ document.getElementById('q').value=''; loadAll(); });
document.getElementById('q').addEventListener('input', ()=>{ clearTimeout(window._t); window._t = setTimeout(loadAll, 150); });
loadAll();
</script>
</body>
</html>
